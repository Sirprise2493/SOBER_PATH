<div class="public-profile-card">
  <!-- Header: Avatar + Username in a row -->
  <div class="public-profile-header">
    <div class="public-profile-header__avatar">
      <% if user.avatar.attached? %>
        <%= image_tag user.avatar
                          .variant(resize_to_fill: [48, 48])
                          .processed,
                      alt: user.username,
                      class: "public-profile-header__avatar-image" %>
      <% else %>
        <div class="public-profile-header__avatar-fallback">
          <span><%= user.username.to_s.first.to_s.upcase.presence || "?" %></span>
        </div>
      <% end %>
    </div>

    <div class="public-profile-header__info">
      <h2 class="public-profile-header__username"><%= user.username %></h2>

      <p class="public-profile-header__meta">
        <strong>Sobriety days:</strong> <%= user.sobriety_days %>
      </p>

      <% if user.headline.present? %>
        <p class="public-profile-header__headline"><%= user.headline %></p>
      <% end %>

      <% if user.bio.present? %>
        <%= simple_format(user.bio, class: "public-profile-header__bio") %>
      <% end %>

      <% if user.counsellor? %>
        <p><span class="badge badge-info">Counsellor</span></p>
      <% end %>
    </div>
  </div>

  <!-- Single custom divider -->
  <div class="user-profile-panel__divider"></div>

  <!-- Connection section -->
  <div class="user-profile-panel__connection">
    <div class="user-profile-panel__connection-header">
      <h3>Connection</h3>

      <div class="user-profile-panel__connection-actions">
        <% if current_user.counsellor? && current_user != user %>
          <%= button_to "Dismiss",
                        user_path(user),
                        method: :delete,
                        data: { turbo_confirm: "Delete this user permanently?" },
                        class: "btn btn-sm btn-outline-danger user-profile-panel__dismiss-button" %>
        <% end %>

      <% if !current_user.connected_with?(user) &&
            !current_user.pending_friend_request_for?(user) %>
        <%= button_to "Connect",
                      friendships_path(receiver_id: user.id),
                      method: :post,
                      class: "btn btn-primary user-profile-panel__connect-button" %>
      <% end %>
    </div>

    <% if current_user.connected_with?(user) %>

      <p class="user-profile-panel__status">
        You are connected.
      </p>

    <% elsif current_user.pending_friend_request_for?(user) %>

      <% if @friendship&.asker == current_user %>

        <p class="user-profile-panel__status">
          Connection request sent. Waiting for response.
        </p>

      <% else %>
        <!-- Incoming request block -->
        <div class="connection-request">
          <div class="connection-request__user">
            <div class="connection-request__avatar">
              <% if user.avatar.attached? %>
                <%= image_tag user.avatar
                                  .variant(resize_to_fill: [32, 32])
                                  .processed,
                              alt: user.username,
                              class: "connection-request__avatar-image" %>
              <% else %>
                <div class="connection-request__avatar-fallback">
                  <span><%= user.username.to_s.first.to_s.upcase.presence || "?" %></span>
                </div>
              <% end %>
            </div>

            <div class="connection-request__info">
              <p class="connection-request__username"><%= user.username %></p>
              <p class="connection-request__text">
                <%= user.username %> has sent you a connection request.
              </p>
            </div>
          </div>

          <div class="connection-request__actions">
            <%= button_to "Accept",
                          friendship_path(@friendship, status: "accepted"),
                          method: :patch,
                          class: "btn btn-sm btn-primary me-2" %>

            <%= button_to "Decline",
                          friendship_path(@friendship, status: "declined"),
                          method: :patch,
                          data: { turbo_confirm: "Decline this request?" },
                          class: "btn btn-sm btn-outline-secondary" %>
          </div>
        </div>
      <% end %>

    <% end %>
  </div>
</div>

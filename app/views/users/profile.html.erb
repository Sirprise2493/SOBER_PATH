<div class="profile-wrapper">

  <h1 class="profile-title">My Profile</h1>

  <div class="profile-grid">

    <!-- LEFT CARD: avatar + name -->
    <div class="profile-card profile-card--left">

      <h2 class="profile-card-title">
        <%= @user.fullname.presence || "Fullname" %>
      </h2>


<div class="profile-avatar-container">
  <% if @user.avatar.attached? %>
    <%= image_tag @user.avatar
                      .variant(resize_to_fill: [220, 220])
                      .processed,
                  alt: @user.username,
                  class: "profile-avatar" %>
  <% else %>
    <div class="profile-avatar placeholder-avatar">
      <i>No Photo</i>
    </div>
  <% end %>
</div>




      <div class="profile-edit-wrapper">
        <%= link_to "Edit profile",
                    edit_profile_path,
                    class: "profile-edit-button" %>
      </div>

    </div>

    <!-- RIGHT CARD: details -->
    <div class="profile-card profile-card--right">

      <h2 class="profile-card-title">Bio & other details</h2>

      <div class="profile-details-grid">

        <div class="profile-field">
          <label>Username</label>
          <div class="profile-field-value"><%= @user.username %></div>
        </div>

        <div class="profile-field">
          <label>Date of Birth</label>
          <div class="profile-field-value"><%= @user.date_of_birth || "—" %></div>
        </div>

        <div class="profile-field">
          <label>Start Date</label>
          <div class="profile-field-value"><%= @user.sobriety_start_date || "—" %></div>
        </div>

        <div class="profile-field">
          <label>Current Streak</label>
          <div class="profile-field-value"><%= @user.sobriety_days %> days</div>
        </div>

        <div class="profile-field full-width">
          <label>Headline</label>
          <div class="profile-field-value">
            <%= @user.headline.presence || "—" %>
          </div>
        </div>

        <div class="profile-field full-width">
          <label>Address</label>
          <div class="profile-field-value">
            <%= @user.address.presence || "—" %>
          </div>
        </div>

        <div class="profile-field full-width">
          <label>Bio</label>
          <div class="profile-field-value">
            <%= simple_format(@user.bio.to_s.presence || "—") %>
          </div>
        </div>

      </div>

    </div>

  </div>

  <!-- CONNECTIONS CARD -->
  <div class="profile-card profile-card--connections" data-controller="connections">

    <h2 class="profile-card-title">My connections</h2>

    <!-- FRIENDS -->
    <h3 class="profile-subtitle">Friends</h3>

    <% if @friends.any? %>
      <% visible_friends = @friends.first(5) %>

      <ul class="profile-list">
        <% visible_friends.each do |friend| %>
          <li class="profile-list-item">
            <span>
              <%= link_to friend.username, user_path(friend) %>
              <% if friend.sobriety_start_date.present? %>
                – <%= pluralize(friend.sobriety_days, "day") %> sober
              <% end %>
            </span>
          </li>
        <% end %>
      </ul>

      <% if @friends.count > 5 %>
        <button
          class="profile-show-more"
          data-action="click->connections#toggle"
          data-connections-target="button"
          data-total="<%= @friends.count %>">
          Show all <%= @friends.count %> friends
        </button>

        <ul class="profile-list d-none" data-connections-target="fullList">
          <% @friends.drop(5).each do |friend| %>
            <li class="profile-list-item">
              <span>
                <%= link_to friend.username, user_path(friend) %>
                <% if friend.sobriety_start_date.present? %>
                  – <%= pluralize(friend.sobriety_days, "day") %> sober
                <% end %>
              </span>
            </li>
          <% end %>
        </ul>
      <% end %>
    <% else %>
      <p class="profile-empty">No connections yet.</p>
    <% end %>

    <!-- INCOMING -->
    <h3 class="profile-subtitle">Incoming requests</h3>
    <% if @incoming_requests.present? %>
      <ul class="profile-list">
        <% @incoming_requests.each do |fr| %>
          <li class="profile-list-item">
            <span>
              <%= link_to fr.asker.username, user_path(fr.asker) %>
              (<%= fr.status_of_friendship_request %>)
            </span>

            <span class="profile-actions">
              <%= button_to "Accept",
                            friendship_path(fr, status: "accepted"),
                            method: :patch,
                            class: "btn btn-sm btn-success" %>

              <%= button_to "Decline",
                            friendship_path(fr, status: "declined"),
                            method: :patch,
                            data: { turbo_confirm: "Decline this request?" },
                            class: "btn btn-sm btn-outline-secondary" %>
            </span>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="profile-empty">No incoming requests.</p>
    <% end %>

    <!-- OUTGOING -->
    <h3 class="profile-subtitle">Outgoing requests</h3>
    <% if @outgoing_requests.present? %>
      <ul class="profile-list">
        <% @outgoing_requests.each do |fr| %>
          <li class="profile-list-item">
            <span>
              <%= link_to fr.receiver.username, user_path(fr.receiver) %>
              (<%= fr.status_of_friendship_request %>)
            </span>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="profile-empty">No outgoing requests.</p>
    <% end %>

  </div>

</div>

<div class="profile-footer">
  <%= link_to "Change Password", edit_user_registration_path, class: "profile-footer-link" %>
  <%= link_to "Log out", destroy_user_session_path, method: :delete, class: "profile-footer-link" %>
</div>

<%# app/views/pages/_venue_form.html.erb (single compact file) %>
<div id="new-venue" class="venue-wrapper mb-4">
  <div class="card-header py-2 d-flex align-items-center justify-content-between">
    <h3 class="h2 mb-0"><%= venue.persisted? ? "Edit venue" : "Create a new venue" %></h3>
  </div>

  <%= simple_form_for venue,
        html: { class: "card-body pt-3 pb-2", data: { controller: "nested" } } do |f| %>

    <div class="row g-3">
      <!-- LEFT: Venue -->
      <div class="col-12 col-lg-5">
        <div class="row g-2">
          <div class="col-12">
            <%= f.input :name, required: true, label: "Name",
                input_html: { class: "form-control form-control-sm" },
                label_html: { class: "form-label form-label-sm mb-1" } %>
          </div>
          <div class="col-12">
            <%= f.input :street, label: "Street",
                input_html: { class: "form-control form-control-sm" },
                label_html: { class: "form-label form-label-sm mb-1" } %>
          </div>
          <div class="col-6">
            <%= f.input :zip, label: "ZIP",
                input_html: { class: "form-control form-control-sm" },
                label_html: { class: "form-label form-label-sm mb-1" } %>
          </div>
          <div class="col-6">
            <%= f.input :city, label: "City",
                input_html: { class: "form-control form-control-sm" },
                label_html: { class: "form-label form-label-sm mb-1" } %>
          </div>
          <div class="col-12">
            <label class="form-label form-label-sm mb-1">Country</label>
            <%= country_select :aa_venue, :country,
                  priority_countries: %w[DE AT CH],
                  selected: (venue.country.presence || "DE"),
                  include_blank: "Select country",
                  class: "form-select form-select-sm" %>
          </div>
          <div class="col-12">
            <%= f.input :website_url, label: "Website URL",
                input_html: { class: "form-control form-control-sm", placeholder: "https://…" },
                label_html: { class: "form-label form-label-sm mb-1" } %>
          </div>
          <div class="col-12">
            <%= f.input :notes, as: :text, label: "Notes",
                input_html: { class: "form-control form-control-sm", rows: 3 },
                label_html: { class: "form-label form-label-sm mb-1" } %>
          </div>
        </div>
      </div>

      <!-- RIGHT: Meetings -->
      <div class="col-12 col-lg-7">
        <div class="border rounded-3 h-100">
          <div class="d-flex align-items-center justify-content-between px-3 py-2 bg-light border-bottom rounded-top">
            <h4 class="h6 mb-0 blue-text">Meetings</h4>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-action="nested#add">
              + Add meeting
            </button>
          </div>

          <div class="p-3">
            <div class="d-flex flex-column gap-2 meetings-rows" data-nested-target="container">
              <%# ==== INLINE MEETING ROW (no partial) ==== %>
              <%= f.simple_fields_for :aa_meetings do |mf| %>
                <div class="border rounded-3 px-2 py-2 bg-white"
                     data-controller="meeting-row"
                     data-nested-target="row">
                  <div class="row g-2 align-items-center">
                    <div class="col-6 col-md-3">
                      <%= mf.input :weekday,
                          collection: AaMeeting.weekdays.keys.map { |k| [k.titleize, k] },
                          include_blank: false, label: "Day",
                          input_html: { class: "form-select form-select-sm" },
                          label_html: { class: "form-label form-label-sm mb-1" } %>
                    </div>

                    <div class="col-6 col-md-2">
                      <%= mf.input :starts_at, as: :select, label: "Start",
                          collection: times_15min_collection, include_blank: false,
                          input_html: { class: "form-select form-select-sm",
                                        data: { meeting_row_target: "start", action: "change->meeting-row#recalc" } },
                          label_html: { class: "form-label form-label-sm mb-1" } %>
                    </div>

                    <div class="col-6 col-md-2">
                      <%= mf.input :duration_minutes, as: :select, label: "Duration",
                          collection: duration_collection, include_blank: false,
                          input_html: { class: "form-select form-select-sm",
                                        data: { meeting_row_target: "duration", action: "change->meeting-row#recalc" } },
                          label_html: { class: "form-label form-label-sm mb-1" } %>
                    </div>

                    <div class="col-6 col-md-2">
                      <label class="form-label form-label-sm mb-1 d-block">Ends</label>
                      <div class="form-control form-control-sm bg-light" data-meeting-row-target="endsPreview">—</div>
                      <%= mf.input :ends_at, as: :hidden,
                          input_html: { data: { meeting_row_target: "endsHidden" } }, label: false %>
                    </div>

                    <div class="col-12 col-md-1 d-flex align-items-center">
                      <%= mf.input :is_online, as: :boolean, label: "Online?",
                          input_html: { class: "form-check-input",
                                        data: { action: "change->meeting-row#toggleOnline" } },
                          wrapper_html: { class: "mb-0" } %>
                    </div>

                    <div class="col-12 col-md-8" data-meeting-row-target="onlineUrlWrap">
                      <%= mf.input :online_url, label: "Online URL",
                          input_html: { class: "form-control form-control-sm", placeholder: "https://…" },
                          label_html: { class: "form-label form-label-sm mb-1" } %>
                    </div>

                    <div class="col-12 col-md-1 d-flex justify-content-md-end">
                      <%= mf.input :_destroy, as: :hidden %>
                      <button class="btn btn-outline-danger btn-sm" type="button" data-action="nested#remove">Remove</button>
                    </div>
                  </div>
                </div>
              <% end %>
              <%# ==== /INLINE MEETING ROW ==== %>
            </div>

            <!-- Template for new rows (also inline) -->
            <template data-nested-target="template">
              <%= f.simple_fields_for :aa_meetings, AaMeeting.new, child_index: "NEW_RECORD" do |mf| %>
                <div class="border rounded-3 px-2 py-2 bg-white"
                     data-controller="meeting-row"
                     data-nested-target="row">
                  <div class="row g-2 align-items-center">
                    <div class="col-6 col-md-3">
                      <%= mf.input :weekday,
                          collection: AaMeeting.weekdays.keys.map { |k| [k.titleize, k] },
                          include_blank: false, label: "Day",
                          input_html: { class: "form-select form-select-sm" },
                          label_html: { class: "form-label form-label-sm mb-1" } %>
                    </div>
                    <div class="col-6 col-md-2">
                      <%= mf.input :starts_at, as: :select, label: "Start",
                          collection: times_15min_collection, include_blank: false,
                          input_html: { class: "form-select form-select-sm",
                                        data: { meeting_row_target: "start", action: "change->meeting-row#recalc" } },
                          label_html: { class: "form-label form-label-sm mb-1" } %>
                    </div>
                    <div class="col-6 col-md-2">
                      <%= mf.input :duration_minutes, as: :select, label: "Duration",
                          collection: duration_collection, include_blank: false,
                          input_html: { class: "form-select form-select-sm",
                                        data: { meeting_row_target: "duration", action: "change->meeting-row#recalc" } },
                          label_html: { class: "form-label form-label-sm mb-1" } %>
                    </div>
                    <div class="col-6 col-md-2">
                      <label class="form-label form-label-sm mb-1 d-block">Ends</label>
                      <div class="form-control form-control-sm bg-light" data-meeting-row-target="endsPreview">—</div>
                      <%= mf.input :ends_at, as: :hidden,
                          input_html: { data: { meeting_row_target: "endsHidden" } }, label: false %>
                    </div>
                    <div class="col-12 col-md-1 d-flex align-items-center">
                      <%= mf.input :is_online, as: :boolean, label: "Online?",
                          input_html: { class: "form-check-input",
                                        data: { action: "change->meeting-row#toggleOnline" } },
                          wrapper_html: { class: "mb-0" } %>
                    </div>
                    <div class="col-12 col-md-8" data-meeting-row-target="onlineUrlWrap">
                      <%= mf.input :online_url, label: "Online URL",
                          input_html: { class: "form-control form-control-sm", placeholder: "https://…" },
                          label_html: { class: "form-label form-label-sm mb-1" } %>
                    </div>
                    <div class="col-12 col-md-1 d-flex justify-content-md-end">
                      <%= mf.input :_destroy, as: :hidden %>
                      <button class="btn btn-outline-danger btn-sm" type="button" data-action="nested#remove">Remove</button>
                    </div>
                  </div>
                </div>
              <% end %>
            </template>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 pt-3">
      <%= f.button :submit, (venue.persisted? ? "Save changes" : "Create venue"), class: "btn btn-success btn-sm" %>
      <%= link_to "Cancel", meetings_path, data: { turbo_frame: "venue_form" },
            class: "btn btn-outline-secondary btn-sm" %>
    </div>
  <% end %>
</div>

<style>
  /* page-local compact tweaks */
  #new-venue .form-label-sm { font-size: .8rem; }
  .meetings-rows { max-height: 340px; overflow: auto; }
</style>

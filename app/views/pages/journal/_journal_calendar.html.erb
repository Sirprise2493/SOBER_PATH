<% date          = local_assigns.fetch(:date) %>          <%# aktueller Journal-Tag %>
<% today         = local_assigns.fetch(:today) %>
<% calendar_date = local_assigns.fetch(:calendar_date) %> <%# sichtbarer Monat/Jahr im Kalender %>
<% entry_dates   = Array(local_assigns[:entry_dates]) %>

<% month_start   = calendar_date.beginning_of_month %>
<% month_end     = calendar_date.end_of_month %>
<% days_in_month = month_end.day %>

<% # Montag als erster Wochentag: Ruby wday 0=So,1=Mo,… -> wir wollen 0=Mo %>
<% start_wday = (month_start.wday - 1) % 7 %>

<div class="journal-calendar-wrapper">
  <!-- Linke Karte: aktueller Journal-Tag -->
  <div class="journal-calendar-summary">
    <div class="journal-calendar-summary__day-number">
      <%= date.day %>
    </div>
    <div class="journal-calendar-summary__weekday">
      <%= l(date, format: "%A").upcase %>
    </div>
  </div>

  <!-- Rechte Seite: Kalender -->
  <div class="journal-calendar">
    <div class="journal-calendar__topbar">
      <!-- Monatszeile -->
      <div class="journal-calendar__months">
        <% months = %w[Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec] %>
        <% months.each_with_index do |name, index| %>
          <% month_number = index + 1 %>
          <% month_date   = calendar_date.change(month: month_number, day: 1) %>
          <% month_classes = ["journal-calendar__month"] %>
          <% month_classes << "journal-calendar__month--active" if calendar_date.month == month_number %>

          <%= link_to name,
                      journal_path(date: date,
                                   calendar_date: month_date,
                                   anchor: "journal-bottom"),
                      class: month_classes.join(" ") %>
        <% end %>
      </div>

      <!-- Jahres-Navigation -->
      <div class="journal-calendar__year-nav">
        <%= link_to "‹",
                    journal_path(date: date,
                                 calendar_date: calendar_date.prev_year,
                                 anchor: "journal-bottom"),
                    class: "journal-calendar__year-btn",
                    title: "Previous year" %>

        <span class="journal-calendar__year-label">
          <%= calendar_date.year %>
        </span>

        <%= link_to "›",
                    journal_path(date: date,
                                 calendar_date: calendar_date.next_year,
                                 anchor: "journal-bottom"),
                    class: "journal-calendar__year-btn",
                    title: "Next year" %>
      </div>
    </div>

    <!-- Wochentage -->
    <div class="journal-calendar__weekdays">
      <% %w[Mon Tue Wed Thu Fri Sat Sun].each do |wd| %>
        <div class="journal-calendar__weekday"><%= wd %></div>
      <% end %>
    </div>

    <!-- Tage -->
    <div class="journal-calendar__grid">
      <% # Leere Zellen vor dem 1. des Monats %>
      <% start_wday.times do %>
        <div class="journal-calendar__day journal-calendar__day--empty"></div>
      <% end %>

      <% (1..days_in_month).each do |day_num| %>
        <% day_date = Date.new(calendar_date.year, calendar_date.month, day_num) %>

        <% classes = ["journal-calendar__day"] %>
        <% classes << "journal-calendar__day--today"    if day_date == today %>
        <% classes << "journal-calendar__day--selected" if day_date == date %>

        <% has_entry = entry_dates.include?(day_date) %>
        <% classes << "journal-calendar__day--has-entry" if has_entry %>

        <div class="<%= classes.join(" ") %>">
          <% if has_entry %>
            <%= link_to day_num,
                        journal_path(date: day_date,
                                     calendar_date: calendar_date,
                                     anchor: "journal-bottom"),
                        class: "journal-calendar__day-link" %>
          <% else %>
            <span class="journal-calendar__day-label"><%= day_num %></span>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
